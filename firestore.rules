rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own document
      allow read: if isOwner(userId);

      // Users can create their own document (on first sign-in)
      allow create: if isOwner(userId)
        && request.resource.data.uid == userId
        && request.resource.data.subscriptionStatus == 'free'
        && request.resource.data.subscriptionTier == 'free'
        && request.resource.data.stripeCustomerId == null
        && request.resource.data.stripeSubscriptionId == null
        && request.resource.data.stripePriceId == null
        && request.resource.data.currentPeriodEnd == null;

      // Users can update their own document, but NOT subscription fields
      allow update: if isOwner(userId)
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.subscriptionStatus == resource.data.subscriptionStatus
        && request.resource.data.subscriptionTier == resource.data.subscriptionTier
        && request.resource.data.stripeCustomerId == resource.data.stripeCustomerId
        && request.resource.data.stripeSubscriptionId == resource.data.stripeSubscriptionId
        && request.resource.data.stripePriceId == resource.data.stripePriceId
        && request.resource.data.currentPeriodEnd == resource.data.currentPeriodEnd;

      // Only server can delete (via Firebase Admin SDK)
      allow delete: if false;
    }

    // User favorites collection (Pro feature - will be implemented later)
    match /user_favorites/{favoriteId} {
      // Users can read their own favorites
      allow read: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Users can create their own favorites
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // Users can delete their own favorites
      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // No updates allowed
      allow update: if false;
    }

    // Exhibitions collection (read-only for all users)
    match /exhibitions/{exhibitionId} {
      allow read: if true;
      allow write: if false;
    }

    // Stripe webhook events (server-only)
    match /stripe_webhooks/{eventId} {
      allow read, write: if false;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
